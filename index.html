<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹•ç‰©ç¯€å¥æŒ‘æˆ°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse-custom {

            0%,
            100% {
                transform: scale(1);
                border-color: transparent;
            }

            50% {
                transform: scale(1.1);
                border-color: #ef4444;
            }
        }

        .active-beat {
            animation: pulse-custom 0.1s ease-in-out;
            border: 6px solid #ef4444 !important;
            z-index: 10;
            background-color: #fef2f2;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 1rem;
            width: 100%;
            max-width: 900px;
        }

        .prep-glow {
            text-shadow: 0 0 20px rgba(239, 68, 68, 0.8);
        }

        .upload-dashed {
            border: 2px dashed #475569;
            transition: all 0.3s;
        }

        .upload-dashed:hover {
            border-color: #eab308;
            background: #1e293b;
        }

        /* ç´”æ–‡å­—å¡ç‰‡å®¹å™¨ */
        .text-auto-size {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            text-align: center;
            overflow: hidden;
            white-space: nowrap;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 10px;
        }

        #loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.9);
            z-index: 100;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        input:disabled,
        input[type="range"]:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @keyframes slideUpFadeIn {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card-enter {
            animation: slideUpFadeIn 0.3s ease-out forwards;
            opacity: 0;
        }

        .card-name-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            font-size: 48px;
            font-weight: bold;
            color: #000000;
            text-shadow: 
                -2px -2px 0 #ffffff,
                2px -2px 0 #ffffff,
                -2px 2px 0 #ffffff,
                2px 2px 0 #ffffff,
                0 -2px 0 #ffffff,
                0 2px 0 #ffffff,
                -2px 0 0 #ffffff,
                2px 0 0 #ffffff;
            text-align: center;
            padding: 8px;
            z-index: 5;
            pointer-events: none;
        }

        #preview-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        #preview-modal.show {
            display: flex;
        }

        .preview-modal-content {
            background: #1e293b;
            border-radius: 1rem;
            padding: 2rem;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .preview-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 1rem;
            aspect-ratio: 2/1;
        }

        .preview-card {
            background: #475569;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            min-height: 100px;
        }

        .preview-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-card-name {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            font-size: 24px;
            font-weight: bold;
            color: #000000;
            text-shadow: 
                -1px -1px 0 #ffffff,
                1px -1px 0 #ffffff,
                -1px 1px 0 #ffffff,
                1px 1px 0 #ffffff;
            text-align: center;
            padding: 4px;
            background: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>

<body class="bg-slate-900 text-white min-h-screen flex flex-col items-center justify-center p-4">

    <!-- è¼‰å…¥ä¸­é®ç½© -->
    <div id="loading-overlay">
        <div class="w-16 h-16 border-4 border-yellow-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-yellow-400 font-bold text-xl">æº–å‚™éŠæˆ²ç´ æä¸­...</p>
        <p id="loading-progress" class="text-slate-400 text-sm mt-2">0%</p>
    </div>

    <!-- è¨­å®šä»‹é¢ -->
    <div id="setup-screen" class="w-full max-w-2xl bg-slate-800 p-8 rounded-2xl shadow-2xl my-8">
        <h1 class="text-3xl font-bold mb-6 text-center text-yellow-400">å‹•ç‰©ç¯€å¥æŒ‘æˆ°</h1>

        <div class="mb-8 p-6 rounded-xl bg-slate-700/30 border border-slate-600">
            <h2 class="text-sm font-semibold text-slate-400 uppercase tracking-widest mb-2 text-left">éŸ³æ¨‚è¨­å®šï¼ˆé¸å¡«ï¼‰</h2>
            <p class="text-[10px] text-slate-500 mb-2 text-left">æç¤ºï¼šè‹¥ä¸æä¾›éŸ³æ¨‚ï¼Œç³»çµ±å°‡è‡ªå‹•ç”¢ç”Ÿé›»å­é¼“è²ã€‚</p>
            <div class="grid grid-cols-1 gap-4">
                <button id="use-default-music"
                    class="w-full py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-bold transition-all flex items-center justify-center gap-2 mb-2">
                    <svg id="music-btn-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                        fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"
                            clip-rule="evenodd" />
                    </svg>
                    <span id="music-btn-text">ä½¿ç”¨é è¨­æŒ‘æˆ°éŸ³æ¨‚ (BPM 183)</span>
                </button>

                <div class="upload-dashed p-6 rounded-xl text-center bg-slate-800/50">
                    <input type="file" id="music-upload" accept="audio/mp3,audio/mpeg" class="hidden">
                    <label for="music-upload" class="cursor-pointer flex flex-col items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-yellow-500 mb-2" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                        </svg>
                        <span id="music-status"
                            class="text-base text-slate-300 font-medium truncate w-full px-4 text-center">ä¸Šå‚³éŸ³æ¨‚æª”æ¡ˆ
                            (MP3)</span>
                        <span class="text-xs text-slate-500 mt-1">é¸ç”¨éŸ³æ¨‚æ™‚ï¼Œç³»çµ±å°‡è‡ªå‹•é—œé–‰é è¨­é¼“è²</span>
                    </label>
                </div>
            </div>
        </div>

        <div id="settings-group" class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-6 p-6 bg-slate-700/50 rounded-xl">
            <div class="space-y-2">
                <label class="block text-sm font-semibold text-slate-300">é–‹é ­é å‚™æ‹æ•¸</label>
                <input type="number" id="start-prep-beats" value="12" min="4" max="32"
                    class="w-full p-2 rounded bg-slate-800 border border-slate-600 focus:ring-2 focus:ring-yellow-400 outline-none">
            </div>
            <div class="space-y-2">
                <label class="block text-sm font-semibold text-slate-300">çµ„é–“éæ¸¡æ‹æ•¸</label>
                <input type="number" id="level-gap-beats" value="8" min="0" max="16"
                    class="w-full p-2 rounded bg-slate-800 border border-slate-600 focus:ring-2 focus:ring-yellow-400 outline-none">
            </div>
            <div class="md:col-span-2 space-y-2">
                <label class="flex justify-between text-sm font-semibold text-slate-300">
                    <span>éŠæˆ²é€Ÿåº¦ (BPM)</span>
                    <span id="bpm-display" class="text-yellow-400 font-mono">183 BPM</span>
                </label>
                <input type="range" id="bpm-slider" min="60" max="240" value="183"
                    class="w-full h-2 bg-slate-600 rounded-lg appearance-none cursor-pointer accent-yellow-400">
            </div>
        </div>

        <div class="flex justify-between items-center mb-2 px-1">
            <h2 class="text-sm font-semibold text-slate-400 uppercase tracking-widest">æŒ‘æˆ°å…§å®¹è¨­å®š</h2>
            <button id="clear-all-btn"
                class="text-xs font-bold text-red-400 hover:text-red-300 transition-colors flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                æ¸…é™¤æ‰€æœ‰å¡«å¯«å…§å®¹
            </button>
        </div>

        <div class="space-y-4 max-h-[300px] overflow-y-auto pr-2 custom-scrollbar">
            <template id="input-row">
                <div class="flex gap-2 mb-4 items-center">
                    <input type="text" placeholder="åç¨±"
                        class="item-name flex-1 p-3 rounded bg-slate-700 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-yellow-400">
                    <div class="relative flex-1 flex items-center gap-1">
                        <input type="text" placeholder="åœ–ç‰‡é€£çµ"
                            class="item-url w-full p-3 rounded bg-slate-700 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-yellow-400">
                        <button type="button"
                            class="upload-item-img-btn p-2 bg-slate-600 hover:bg-slate-500 rounded-lg shrink-0 h-[50px]">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-400" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                        </button>
                        <input type="file" class="item-img-file hidden" accept="image/*">
                    </div>
                </div>
            </template>
            <div id="inputs-container"></div>
        </div>

        <div class="mt-4 flex items-center justify-between p-3 bg-slate-700/30 rounded-lg">
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="show-name-checkbox" class="w-5 h-5 rounded border-slate-600 bg-slate-800 text-yellow-400 focus:ring-2 focus:ring-yellow-400 cursor-pointer">
                    <label for="show-name-checkbox" class="text-sm font-semibold text-slate-300 cursor-pointer">
                        åœ¨åœ–ç‰‡ä¸Šé¡¯ç¤ºåç¨±
                    </label>
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="enable-animation-checkbox" checked class="w-5 h-5 rounded border-slate-600 bg-slate-800 text-yellow-400 focus:ring-2 focus:ring-yellow-400 cursor-pointer">
                    <label for="enable-animation-checkbox" class="text-sm font-semibold text-slate-300 cursor-pointer">
                        å•Ÿç”¨åœ–ç‰‡é€²å…¥å‹•ç•«
                    </label>
                </div>
            </div>
            <button id="preview-btn" class="px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white text-sm font-semibold rounded-lg transition-colors">
                é è¦½æ‰€æœ‰é¡Œç›®
            </button>
        </div>

        <button id="start-btn"
            class="w-full mt-8 bg-yellow-500 hover:bg-yellow-400 text-slate-900 font-bold py-4 rounded-xl transition-all transform hover:scale-105 active:scale-95 text-xl">
            é–‹å§‹éŠæˆ²
        </button>
    </div>

    <!-- éŠæˆ²ä»‹é¢ -->
    <div id="game-screen" class="hidden w-full max-w-5xl flex flex-col items-center">
        <div class="flex justify-between w-full mb-6 px-4 items-end">
            <div>
                <div class="text-sm text-slate-400 uppercase tracking-widest">Level</div>
                <div class="text-4xl font-black text-yellow-400"><span id="current-level">1</span> <span
                        class="text-xl text-slate-600">/ 5</span></div>
            </div>
            <div id="status-display" class="text-right">
                <div class="text-sm text-slate-400 uppercase tracking-widest">Status</div>
                <div id="status-text" class="text-4xl font-black text-red-500 prep-glow">
                    <span id="status-label">é å‚™ï¼š</span><span id="countdown">12</span>
                </div>
            </div>
        </div>
        <div id="grid-display"
            class="grid-container aspect-[2/1] bg-slate-800 p-4 rounded-3xl border-8 border-slate-700 shadow-2xl relative">
        </div>
        <div class="mt-12 text-center">
            <p id="instruction" class="text-xl text-yellow-400 font-bold">è·Ÿè‘—ç¯€å¥ï¼</p>
            <button id="give-up-btn"
                class="mt-8 text-slate-500 underline hover:text-white transition text-sm">æ”¾æ£„æŒ‘æˆ°</button>
        </div>
    </div>

    <!-- çµç®—é é¢ -->
    <div id="result-screen"
        class="hidden w-full max-w-md bg-slate-800 p-10 rounded-3xl shadow-2xl text-center border-4 border-yellow-500">
        <div class="text-6xl mb-6">ğŸ†</div>
        <h2 class="text-3xl font-black text-yellow-400 mb-2">æŒ‘æˆ°å®Œæˆï¼</h2>
        <p class="text-slate-400 mb-8">ä½ çš„ç¯€å¥æ„ŸçœŸæ˜¯å¤ªæ£’äº†ï¼</p>

        <div class="space-y-4">
            <button id="retry-btn"
                class="w-full bg-yellow-500 hover:bg-yellow-400 text-slate-900 font-bold py-4 rounded-xl transition-all transform hover:scale-105 active:scale-95 text-lg">
                å†æ¬¡æŒ‘æˆ°
            </button>
            <button id="back-to-setup-btn"
                class="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-4 rounded-xl transition-all">
                è¿”å›è¨­å®šé é¢
            </button>
        </div>
    </div>

    <!-- é è¦½å½ˆçª— -->
    <div id="preview-modal">
        <div class="preview-modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-yellow-400">æ‰€æœ‰é¡Œç›®é è¦½</h2>
                <button id="close-preview-btn" class="text-slate-400 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="preview-grid-container" class="preview-grid"></div>
        </div>
    </div>

    <script>
        const defaultItems = [
            { name: "è±¬", url: "https://images.unsplash.com/photo-1516467508483-a7212febe31a?q=80&w=400&auto=format&fit=crop" },
            { name: "ç‹—", url: "https://images.unsplash.com/photo-1517849845537-4d257902454a?q=80&w=400&auto=format&fit=crop" },
            { name: "ç¾Š", url: "https://images.unsplash.com/photo-1484557985045-edf25e08da73?q=80&w=400&auto=format&fit=crop" },
            { name: "ç‰›", url: "https://plus.unsplash.com/premium_photo-1668446124029-9a55e3455b69?q=80&w=400&auto=format&fit=crop" },
            { name: "è²“", url: "https://images.unsplash.com/photo-1514888286974-6c03e2ca1dba?q=80&w=400&auto=format&fit=crop" },
            { name: "ç†Š", url: "https://images.unsplash.com/photo-1530595467537-0b5996c41f2d?q=80&w=400&auto=format&fit=crop" },
            { name: "é­š", url: "https://images.unsplash.com/photo-1522069169874-c58ec4b76be5?q=80&w=400&auto=format&fit=crop" },
            { name: "é³¥", url: "https://images.unsplash.com/photo-1486365227551-f3f90034a57c?q=80&w=400&auto=format&fit=crop" }
        ];

        let gameData = [];
        let currentLevel = 1;
        let bpm = 183;
        let startPrepBeats = 12;
        let levelGapBeats = 8;

        let audioCtx = null;
        let musicGainNode = null;
        let bgMusicAudio = null;
        let bgMusicSource = null;

        let nextBeatTime = 0;
        let currentBeat = 0;
        let isPlaying = false;
        let isChallengeMode = false;
        let useProceduralDrums = true; // æ˜¯å¦ä½¿ç”¨é›»å­é¼“è²
        let gameStartTime = 0; // è¨˜éŒ„éŠæˆ²é–‹å§‹çš„æ™‚é–“é»ï¼ˆç”¨æ–¼ç¬¬ä¸€é—œï¼‰
        let levelSwitchTime = 0; // è¨˜éŒ„é—œå¡åˆ‡æ›çš„æ™‚é–“é»ï¼ˆç”¨æ–¼å…¶ä»–é—œï¼‰
        let showNameOnImage = false; // æ˜¯å¦åœ¨åœ–ç‰‡ä¸Šé¡¯ç¤ºåç¨±
        let enableCardAnimation = true; // æ˜¯å¦å•Ÿç”¨åœ–ç‰‡é€²å…¥å‹•ç•«

        const CARDS_PER_LEVEL = 8;
        const imageCache = new Map();

        // åˆå§‹åŒ–è¼¸å…¥æ¡†
        const inputsContainer = document.getElementById('inputs-container');
        const rowTemplate = document.getElementById('input-row');
        function initInputs() {
            inputsContainer.innerHTML = '';
            for (let i = 0; i < 8; i++) {
                const clone = rowTemplate.content.cloneNode(true);
                const rowDiv = clone.querySelector('div');
                const nameInput = rowDiv.querySelector('.item-name');
                const urlInput = rowDiv.querySelector('.item-url');
                const uploadBtn = rowDiv.querySelector('.upload-item-img-btn');
                const fileInput = rowDiv.querySelector('.item-img-file');

                if (defaultItems[i]) {
                    nameInput.value = defaultItems[i].name;
                    urlInput.value = defaultItems[i].url;
                }

                uploadBtn.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        nameInput.value = file.name.replace(/\.[^/.]+$/, "");
                        const reader = new FileReader();
                        reader.onload = (ev) => { urlInput.value = ev.target.result; };
                        reader.readAsDataURL(file);
                    }
                });
                inputsContainer.appendChild(rowDiv);
            }
        }
        initInputs();

        // æ¸…é™¤æ‰€æœ‰å…§å®¹åŠŸèƒ½
        document.getElementById('clear-all-btn').onclick = () => {
            document.querySelectorAll('.item-name').forEach(input => input.value = '');
            document.querySelectorAll('.item-url').forEach(input => input.value = '');
            document.querySelectorAll('.item-img-file').forEach(input => input.value = '');
        };

        const musicUploadInput = document.getElementById('music-upload');
        musicUploadInput.addEventListener('change', function (e) {
            const file = e.target.files[0];
            const status = document.getElementById('music-status');
            if (file) {
                status.innerText = `å·²é¸æª”æ¡ˆï¼š${file.name}`;
                status.classList.add('text-yellow-400');
                if (isChallengeMode) toggleChallengeMode(false);
            } else {
                status.innerText = 'ä¸Šå‚³éŸ³æ¨‚æª”æ¡ˆ (MP3)';
                status.classList.remove('text-yellow-400');
            }
        });

        document.getElementById('use-default-music').onclick = function () {
            toggleChallengeMode(!isChallengeMode);
        };

        function toggleChallengeMode(enable) {
            const btn = document.getElementById('use-default-music');
            const btnText = document.getElementById('music-btn-text');
            const status = document.getElementById('music-status');

            isChallengeMode = enable;
            if (enable) {
                musicUploadInput.value = "";
                status.innerText = 'å·²è¼‰å…¥é è¨­æŒ‘æˆ°éŸ³æ¨‚';
                status.classList.add('text-yellow-400');
                btnText.innerText = 'ç§»é™¤é è¨­æŒ‘æˆ°éŸ³æ¨‚';
                btn.classList.replace('bg-indigo-600', 'bg-red-600');
                lockSettings(true);
            } else {
                status.innerText = 'ä¸Šå‚³éŸ³æ¨‚æª”æ¡ˆ (MP3)';
                status.classList.remove('text-yellow-400');
                btnText.innerText = 'ä½¿ç”¨é è¨­æŒ‘æˆ°éŸ³æ¨‚ (BPM 183)';
                btn.classList.replace('bg-red-600', 'bg-indigo-600');
                lockSettings(false);
            }
        }

        function lockSettings(shouldLock) {
            const bpmSlider = document.getElementById('bpm-slider');
            const startPrep = document.getElementById('start-prep-beats');
            const gapBeats = document.getElementById('level-gap-beats');
            if (shouldLock) {
                bpmSlider.value = 183; bpmSlider.disabled = true;
                document.getElementById('bpm-display').innerText = '183 BPM (é–å®š)';
                startPrep.value = 12; startPrep.disabled = true;
                gapBeats.value = 8; gapBeats.disabled = true;
            } else {
                bpmSlider.disabled = false; startPrep.disabled = false; gapBeats.disabled = false;
                document.getElementById('bpm-display').innerText = `${bpmSlider.value} BPM`;
            }
        }

        // é›»å­å¤§é¼“è²
        function playKickDrum(time) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.frequency.setValueAtTime(150, time);
            osc.frequency.exponentialRampToValueAtTime(40, time + 0.1);
            gain.gain.setValueAtTime(0.6, time);
            gain.gain.exponentialRampToValueAtTime(0.001, time + 0.4);
            osc.start(time);
            osc.stop(time + 0.4);
        }

        // é›»å­å°é¼“è²
        function playSnareDrum(time) {
            const noise = audioCtx.createBufferSource();
            const bufferSize = audioCtx.sampleRate * 0.1;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
            noise.buffer = buffer;
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'highpass';
            filter.frequency.setValueAtTime(1000, time);
            const gain = audioCtx.createGain();
            gain.gain.setValueAtTime(0.15, time);
            gain.gain.exponentialRampToValueAtTime(0.001, time + 0.1);
            noise.connect(filter);
            filter.connect(gain);
            gain.connect(audioCtx.destination);
            noise.start(time);
        }

        function scheduler() {
            if (!isPlaying) return;
            const currentPrep = (currentLevel === 1) ? startPrepBeats : levelGapBeats;
            const beatsThisLevel = currentPrep + CARDS_PER_LEVEL;

            while (nextBeatTime < audioCtx.currentTime + 0.1) {
                const isPrepStage = currentBeat < currentPrep;

                // åªæœ‰åœ¨ä¸ä½¿ç”¨å¤–éƒ¨éŸ³æ¨‚æ™‚æ‰æ’­æ”¾é›»å­é¼“è²
                if (useProceduralDrums) {
                    if (isPrepStage) {
                        playKickDrum(nextBeatTime);
                        if (currentBeat % 2 === 0) playSnareDrum(nextBeatTime);
                    } else {
                        playKickDrum(nextBeatTime);
                    }
                }

                if (isPrepStage) {
                    document.getElementById('countdown').innerText = currentPrep - currentBeat;
                    document.getElementById('status-label').innerText = "é å‚™ï¼š";
                    document.getElementById('status-text').className = "text-4xl font-black text-red-500 prep-glow";
                } else {
                    const imageIdx = currentBeat - currentPrep;
                    document.getElementById('status-text').className = "text-4xl font-black text-green-400";
                    document.getElementById('status-label').innerText = "é–‹å§‹ï¼";
                    document.getElementById('countdown').innerText = "";
                    updateVisualBeat(imageIdx);
                }

                nextBeatTime += 60.0 / bpm;
                currentBeat++;
                if (currentBeat >= beatsThisLevel) {
                    currentBeat = 0;
                    const lastCardIdx = CARDS_PER_LEVEL - 1;
                    updateVisualBeat(lastCardIdx);
                    // è¨˜éŒ„é—œå¡åˆ‡æ›çš„æ™‚é–“é»ï¼ˆåœ¨å»¶é²ä¹‹å‰ï¼‰
                    levelSwitchTime = audioCtx.currentTime;
                    setTimeout(nextLevel, 500);
                }
            }
            requestAnimationFrame(scheduler);
        }

        function updateVisualBeat(idx) {
            const cards = document.querySelectorAll('.item-card');
            cards.forEach(c => c.classList.remove('active-beat'));
            if (cards[idx]) cards[idx].classList.add('active-beat');
        }

        function nextLevel() {
            if (!isPlaying) return;
            if (currentLevel < 5) {
                currentLevel++;
                document.getElementById('current-level').innerText = currentLevel;
                generateLevel();
            } else {
                isPlaying = false;
                if (musicGainNode) musicGainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 2);
                document.getElementById('status-label').innerText = "å®Œæˆï¼";
                document.getElementById('countdown').innerText = ""; // æ¸…ç©ºæ•¸å­—é¡¯ç¤º
                setTimeout(() => {
                    if (bgMusicAudio) bgMusicAudio.pause();
                    document.getElementById('game-screen').classList.add('hidden');
                    document.getElementById('result-screen').classList.remove('hidden');
                }, 2000);
            }
        }

        function generateLevel() {
            const grid = document.getElementById('grid-display');
            grid.innerHTML = '';
            let numTypes = Math.min(currentLevel + 1, gameData.length, 8);
            const candidates = [...gameData].sort(() => 0.5 - Math.random()).slice(0, numTypes);
            
            // è¨ˆç®—æ¯å€‹å¡ç‰‡ä¹‹é–“çš„å»¶é²æ™‚é–“ï¼ˆåŸºæ–¼BPMï¼‰
            const beatDuration = 60.0 / bpm; // æ¯å€‹ç¯€æ‹çš„æ™‚é–“ï¼ˆç§’ï¼‰
            
            // ç¬¬ä¸€é—œï¼šå‹•ç•«å¾ç¬¬4æ‹é–‹å§‹ï¼Œåˆ°ç¬¬12æ‹çµæŸï¼ˆé å‚™æ‹çµæŸï¼‰
            // å…¶ä»–é—œï¼šå‹•ç•«ç«‹å³é–‹å§‹
            let animationStartDelay = 0;
            if (currentLevel === 1) {
                // ç¬¬4æ‹é–‹å§‹ = ç¬¬0ã€1ã€2ã€3æ‹å¾Œ = 3å€‹ç¯€æ‹çš„æ™‚é–“
                // åŸºæ–¼éŠæˆ²é–‹å§‹æ™‚é–“é»è¨ˆç®—ï¼Œç¢ºä¿ä¸å—é—œå¡åˆ‡æ›å»¶é²å½±éŸ¿
                const targetTime = gameStartTime + (3 * beatDuration); // éŠæˆ²é–‹å§‹æ™‚é–“ + ç¬¬4æ‹çš„æ™‚é–“
                const currentTime = audioCtx ? audioCtx.currentTime : Date.now() / 1000;
                animationStartDelay = Math.max(0, targetTime - currentTime);
            }
            
            for (let i = 0; i < CARDS_PER_LEVEL; i++) {
                const item = candidates[Math.floor(Math.random() * candidates.length)];
                const div = document.createElement('div');
                let cardClasses = "item-card bg-white rounded-xl flex items-center justify-center border-4 border-transparent shadow-md relative overflow-hidden";
                
                // å¦‚æœå•Ÿç”¨å‹•ç•«ï¼Œæ·»åŠ å‹•ç•«é¡
                if (enableCardAnimation) {
                    cardClasses += " card-enter";
                }
                
                div.className = cardClasses;
                
                if (item.url) {
                    const img = new Image(); 
                    img.src = item.url; 
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'cover';
                    div.appendChild(img);
                    
                    // å¦‚æœå•Ÿç”¨é¡¯ç¤ºåç¨±åŠŸèƒ½ï¼Œåœ¨åœ–ç‰‡ä¸Šæ·»åŠ åç¨±æ¨™ç±¤
                    if (showNameOnImage && item.name) {
                        const nameLabel = document.createElement('div');
                        nameLabel.className = "card-name-label";
                        nameLabel.innerText = item.name;
                        div.appendChild(nameLabel);
                    }
                } else {
                    const span = document.createElement('span');
                    span.className = "text-auto-size text-slate-900 font-black text-8xl px-2";
                    span.innerText = item.name;
                    div.appendChild(span);
                }
                
                // å¦‚æœå•Ÿç”¨å‹•ç•«ï¼Œè¨­ç½®å‹•ç•«å»¶é²ï¼Œè®“å¡ç‰‡ä¾åºå‡ºç¾
                // ç¬¬ä¸€é—œï¼šå¾ç¬¬4æ‹é–‹å§‹ï¼Œæ¯å€‹å¡ç‰‡é–“éš”1æ‹
                // å…¶ä»–é—œï¼šç«‹å³é–‹å§‹ï¼Œæ¯å€‹å¡ç‰‡é–“éš”1æ‹
                if (enableCardAnimation) {
                    const delay = animationStartDelay + (i * beatDuration);
                    div.style.animationDelay = `${delay}s`;
                }
                
                grid.appendChild(div);
            }
        }

        async function startGame() {
            gameData = [];
            document.querySelectorAll('.item-name').forEach((n, i) => {
                const url = document.querySelectorAll('.item-url')[i].value.trim();
                if (n.value.trim()) gameData.push({ name: n.value.trim(), url });
            });
            if (gameData.length < 4) return alert("è«‹è‡³å°‘å¡«å¯« 4 çµ„å…§å®¹ï¼");

            document.getElementById('loading-overlay').style.display = 'flex';

            try {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') await audioCtx.resume();

                if (!musicGainNode) {
                    musicGainNode = audioCtx.createGain();
                    musicGainNode.connect(audioCtx.destination);
                }

                let finalMusicURL = null;
                const uploadedFile = document.getElementById('music-upload').files[0];

                if (uploadedFile) {
                    finalMusicURL = URL.createObjectURL(uploadedFile);
                    useProceduralDrums = false; // æœ‰éŸ³æ¨‚å°±é—œé–‰é¼“è²
                } else if (isChallengeMode) {
                    finalMusicURL = 'BeatsChallenge_bpm183.mp3';
                    useProceduralDrums = false; // æœ‰éŸ³æ¨‚å°±é—œé–‰é¼“è²
                } else {
                    useProceduralDrums = true; // æ²’é¸éŸ³æ¨‚æ‰ç”¨é¼“è²
                }

                const preloads = [preloadImages(gameData)];

                if (finalMusicURL) {
                    preloads.push(new Promise((resolve) => {
                        if (!bgMusicAudio) {
                            bgMusicAudio = new Audio();
                            bgMusicAudio.loop = true;
                            bgMusicSource = audioCtx.createMediaElementSource(bgMusicAudio);
                            bgMusicSource.connect(musicGainNode);
                        }
                        bgMusicAudio.src = finalMusicURL;
                        bgMusicAudio.oncanplaythrough = () => resolve();
                        bgMusicAudio.onerror = () => { useProceduralDrums = true; resolve(); };
                        bgMusicAudio.load();
                    }));
                }

                await Promise.all(preloads);

                document.getElementById('loading-overlay').style.display = 'none';
                document.getElementById('setup-screen').classList.add('hidden');
                document.getElementById('result-screen').classList.add('hidden');
                document.getElementById('game-screen').classList.remove('hidden');

                bpm = parseInt(document.getElementById('bpm-slider').value);
                startPrepBeats = parseInt(document.getElementById('start-prep-beats').value);
                levelGapBeats = parseInt(document.getElementById('level-gap-beats').value);
                currentLevel = 1;
                document.getElementById('current-level').innerText = "1";
                // è¨˜éŒ„éŠæˆ²é–‹å§‹æ™‚é–“ï¼ˆç”¨æ–¼ç¬¬ä¸€é—œå‹•ç•«è¨ˆç®—ï¼‰
                gameStartTime = audioCtx.currentTime;
                generateLevel();

                if (bgMusicAudio && finalMusicURL) {
                    musicGainNode.gain.setValueAtTime(0.8, audioCtx.currentTime);
                    bgMusicAudio.currentTime = 0;
                    bgMusicAudio.play();
                }

                isPlaying = true;
                currentBeat = 0;
                nextBeatTime = audioCtx.currentTime + 0.1;
                scheduler();
            } catch (err) {
                document.getElementById('loading-overlay').style.display = 'none';
                console.error(err);
                alert("å•Ÿå‹•éŒ¯èª¤ã€‚");
            }
        }

        function preloadImages(data) {
            const urls = data.filter(d => d.url && d.url.length > 10 && !imageCache.has(d.url)).map(d => d.url);
            if (!urls.length) return Promise.resolve();
            let loaded = 0;
            return Promise.all(urls.map(url => new Promise(res => {
                const img = new Image();
                img.src = url;
                img.onload = img.onerror = () => {
                    loaded++;
                    document.getElementById('loading-progress').innerText = `${Math.round(loaded / urls.length * 100)}%`;
                    imageCache.set(url, img);
                    res();
                };
            })));
        }

        document.getElementById('bpm-slider').oninput = function () {
            if (!isChallengeMode) document.getElementById('bpm-display').innerText = `${this.value} BPM`;
        };
        
        // é©—è­‰é–‹é ­é å‚™æ‹æ•¸çš„æœ€å°å€¼
        document.getElementById('start-prep-beats').addEventListener('blur', function() {
            const value = parseInt(this.value);
            if (isNaN(value) || value < 4) {
                this.value = 4;
            } else if (value > 32) {
                this.value = 32;
            }
        });
        
        // é©—è­‰çµ„é–“éæ¸¡æ‹æ•¸çš„æœ€å°å€¼
        document.getElementById('level-gap-beats').addEventListener('blur', function() {
            const value = parseInt(this.value);
            if (isNaN(value) || value < 0) {
                this.value = 0;
            } else if (value > 16) {
                this.value = 16;
            }
        });
        
        // åœ–ç‰‡ä¸Šé¡¯ç¤ºåç¨±çš„é–‹é—œ
        document.getElementById('show-name-checkbox').addEventListener('change', function() {
            showNameOnImage = this.checked;
        });
        
        // åœ–ç‰‡é€²å…¥å‹•ç•«çš„é–‹é—œ
        document.getElementById('enable-animation-checkbox').addEventListener('change', function() {
            enableCardAnimation = this.checked;
        });
        
        // é è¦½æ‰€æœ‰é¡Œç›®åŠŸèƒ½
        function showPreview() {
            const previewGrid = document.getElementById('preview-grid-container');
            previewGrid.innerHTML = '';
            
            // ç²å–æ‰€æœ‰é¡Œç›®è³‡æ–™
            const items = [];
            document.querySelectorAll('.item-name').forEach((nameInput, i) => {
                const urlInput = document.querySelectorAll('.item-url')[i];
                const name = nameInput.value.trim();
                const url = urlInput.value.trim();
                items.push({ name, url });
            });
            
            // é¡¯ç¤º8å€‹æ–¹æ ¼ï¼ˆ4x2ï¼‰
            for (let i = 0; i < 8; i++) {
                const card = document.createElement('div');
                card.className = 'preview-card';
                
                if (items[i] && items[i].name) {
                    // æœ‰å…§å®¹çš„å¡ç‰‡
                    if (items[i].url && items[i].url.length > 10) {
                        // æœ‰åœ–ç‰‡
                        const img = document.createElement('img');
                        img.src = items[i].url;
                        img.onerror = () => {
                            // åœ–ç‰‡è¼‰å…¥å¤±æ•—æ™‚é¡¯ç¤ºåç¨±
                            card.innerHTML = '';
                            const nameSpan = document.createElement('span');
                            nameSpan.className = 'text-slate-900 font-black text-2xl px-2 text-center';
                            nameSpan.innerText = items[i].name;
                            card.appendChild(nameSpan);
                        };
                        card.appendChild(img);
                        
                        // æ·»åŠ åç¨±æ¨™ç±¤
                        const nameLabel = document.createElement('div');
                        nameLabel.className = 'preview-card-name';
                        nameLabel.innerText = items[i].name;
                        card.appendChild(nameLabel);
                    } else {
                        // åªæœ‰åç¨±ï¼Œæ²’æœ‰åœ–ç‰‡
                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'text-slate-900 font-black text-2xl px-2 text-center';
                        nameSpan.innerText = items[i].name;
                        card.appendChild(nameSpan);
                    }
                } else {
                    // æ²’æœ‰å…§å®¹ï¼Œé¡¯ç¤ºç°åº•
                    card.style.backgroundColor = '#475569';
                }
                
                previewGrid.appendChild(card);
            }
            
            // é¡¯ç¤ºå½ˆçª—
            document.getElementById('preview-modal').classList.add('show');
        }
        
        function closePreview() {
            document.getElementById('preview-modal').classList.remove('show');
        }
        
        document.getElementById('preview-btn').onclick = showPreview;
        document.getElementById('close-preview-btn').onclick = closePreview;
        
        // é»æ“Šå½ˆçª—èƒŒæ™¯é—œé–‰
        document.getElementById('preview-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePreview();
            }
        });
        
        document.getElementById('start-btn').onclick = startGame;
        document.getElementById('retry-btn').onclick = startGame;
        document.getElementById('back-to-setup-btn').onclick = () => {
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('setup-screen').classList.remove('hidden');
        };
        document.getElementById('give-up-btn').onclick = () => {
            isPlaying = false;
            if (bgMusicAudio) bgMusicAudio.pause();
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('setup-screen').classList.remove('hidden');
        };
    </script>
</body>

</html>